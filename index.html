<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lumiere Remote X</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    <style>
        /* Variables de th√®mes */
        :root {
            --bg-gradient: radial-gradient(at top left, #e0f2fe, #f1f5f9 50%, #fafaf9);
            --glass-bg: rgba(255, 255, 255, 0.6);
            --text-main: #334155;
            --card-border: rgba(255, 255, 255, 0.8);
            --shadow: rgba(148, 163, 184, 0.15);
            --accent: #38bdf8;
        }

        /* Mode Nuit (Activ√© via la classe .dark-mode) */
        body.dark-mode {
            --bg-gradient: radial-gradient(at top left, #0f172a, #020617);
            --glass-bg: rgba(15, 23, 42, 0.8);
            --text-main: #f1f5f9;
            --card-border: rgba(56, 189, 248, 0.1);
            --shadow: rgba(0, 0, 0, 0.4);
            --accent: #22d3ee;
        }

        body { 
            background: var(--bg-gradient); 
            color: var(--text-main); 
            font-family: 'Inter', sans-serif; 
            min-height: 100vh;
            transition: background 0.8s ease;
        }

        .glass { 
            background: var(--glass-bg); 
            backdrop-filter: blur(15px); 
            border-radius: 32px; 
            border: 1px solid var(--card-border); 
            box-shadow: 0 15px 35px var(--shadow); 
            transition: all 0.4s ease; 
        }

        /* Lueur sp√©ciale en mode nuit pour les lampes allum√©es */
        body.dark-mode .is-on {
            border-color: var(--accent) !important;
            box-shadow: 0 0 25px rgba(34, 211, 238, 0.25);
            background: rgba(30, 41, 59, 0.9) !important;
        }

        .is-on { background: rgba(255, 255, 255, 0.95) !important; border-color: #38bdf8 !important; }

        .label-text { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; color: #64748b; }
        body.dark-mode .label-text { color: #94a3b8; }

        /* Sliders */
        input[type="range"] { -webkit-appearance: none; height: 8px; border-radius: 5px; background: #d1dce8; outline: none; }
        body.dark-mode input[type="range"] { background: #334155; }
        input[type="range"]::-webkit-slider-thumb { 
            -webkit-appearance: none; width: 26px; height: 26px; border-radius: 50%; 
            background: white; border: 4px solid var(--accent); cursor: pointer; 
        }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { background: white; padding: 12px 24px; border-radius: 16px; margin-bottom: 8px; box-shadow: 0 10px 15px var(--shadow); animation: slideIn 0.3s ease-out forwards; color: #1e293b; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="p-4 flex justify-center items-start overscroll-behavior-y-contain">
    <div class="glass w-full max-w-xl p-6 my-4">
        <div id="toast-container"></div>
        
        <header class="max-w-md mx-auto py-6 flex justify-between items-center">
            <div>
                <h1 id="main-title" class="text-4xl font-black italic tracking-tighter bg-gradient-to-br from-sky-500 to-blue-700 bg-clip-text text-transparent">Lumiere X</h1>
                <p id="theme-status" class="label-text mt-1 text-sky-500">Mode Jour</p>
            </div>
            <div class="flex gap-2">
                <button onclick="masterOff()" class="p-3 glass border border-red-500/20 text-red-500 active:scale-90 transition">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                </button>
                <button onclick="loadDevices()" class="p-3 glass border border-white/10 text-sky-400 active:rotate-180 transition duration-500">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                </button>
            </div>
        </header>

        <main id="container" class="max-w-md mx-auto space-y-6"></main>

        <footer class="max-w-md mx-auto mt-12 text-center">
            <button onclick="toggleThemeManually()" class="label-text opacity-40 hover:opacity-100 transition">Changer de th√®me üåó</button>
        </footer>
    </div>

    <script>
        let devicesCache = [];
        let pickers = {};

        window.onload = () => {
            applyAutoTheme();
            loadDevices();
        };

        // --- LOGIQUE DE TH√àME ---
        function applyAutoTheme() {
            const hour = new Date().getHours();
            // Nuit entre 20h et 7h
            const isNight = hour >= 20 || hour < 7;
            setTheme(isNight);
        }

        function setTheme(isNight) {
            if(isNight) {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-status').innerText = "Mode Nuit Actif";
                document.getElementById('main-title').classList.replace('from-sky-500', 'from-cyan-400');
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('theme-status').innerText = "Mode Jour Actif";
                document.getElementById('main-title').classList.replace('from-cyan-400', 'from-sky-500');
            }
        }

        function toggleThemeManually() {
            const isDark = document.body.classList.toggle('dark-mode');
            setTheme(isDark);
        }

        // --- LOGIQUE API (Simplifi√©e pour l'exemple) ---
        async function api(body) {
            try {
                const res = await fetch('/api/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        ...body, 
                        accessId: localStorage.getItem('tuya_id'), 
                        accessSecret: localStorage.getItem('tuya_secret') 
                    })
                });
                return await res.json();
            } catch (e) { return { success: false }; }
        }

        async function loadDevices() {
            const res = await api({ action: 'listDevices' });
            if(res.success) {
                // Tri Online d'abord
                devicesCache = res.result.sort((a, b) => (a.online === b.online) ? 0 : a.online ? -1 : 1);
                document.getElementById('container').innerHTML = devicesCache.map(d => render(d)).join('');
                devicesCache.forEach(d => { if(d.online) syncStatus(d.id); });
            }
        }

        function render(d) {
            const isLight = d.category === 'dj' || d.category === 'dd' || d.name.toLowerCase().includes('lum');
            return `
            <div class="glass p-8 ${!d.online ? 'opacity-40 grayscale pointer-events-none' : ''}" id="card-${d.id}">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="font-black text-xl">${d.name}</h3>
                        <span id="badge-${d.id}" class="label-text opacity-70">${d.online ? 'En ligne' : 'Hors-ligne'}</span>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="sw-${d.id}" onchange="toggleDevice('${d.id}', this.checked)" class="sr-only peer">
                        <div class="w-14 h-7 bg-slate-200 dark:bg-slate-700 rounded-full peer peer-checked:bg-sky-500 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-7 shadow-inner"></div>
                    </label>
                </div>
                ${isLight ? `
                <div class="mt-6 space-y-4 border-t border-black/5 dark:border-white/5 pt-4">
                    <input type="range" id="br-${d.id}" min="10" max="1000" class="w-full" onchange="sendCmd('${d.id}','bright_value_v2',parseInt(this.value))">
                    <div class="flex gap-2">
                        <button onclick="sendCmd('${d.id}','work_mode','white')" class="flex-1 py-2 bg-white/20 rounded-xl text-[10px] font-bold uppercase">Blanc</button>
                        <button onclick="showColor('${d.id}')" class="flex-1 py-2 bg-sky-500/10 text-sky-500 rounded-xl text-[10px] font-bold uppercase">Couleurs</button>
                    </div>
                    <div id="pk-${d.id}" class="hidden flex justify-center py-4"></div>
                </div>` : ''}
            </div>`;
        }

        async function toggleDevice(id, state) {
            updateVisual(id, state);
            const dev = devicesCache.find(x => x.id === id);
            const code = (dev.category === 'dj' || dev.category === 'dd') ? 'switch_led' : 'switch_1';
            await sendCmd(id, code, state);
        }

        function updateVisual(id, isOn) {
            const card = document.getElementById(`card-${id}`);
            if(card) {
                if(isOn) card.classList.add('is-on');
                else card.classList.remove('is-on');
            }
        }

        async function sendCmd(deviceId, code, value) {
            return await api({ action: 'send', deviceId, code, value });
        }

        async function syncStatus(id) {
            const res = await api({ action: 'getStatus', deviceId: id });
            if(res.success && res.result) {
                const s = res.result;
                const statusObj = s.find(x => x.code === 'switch_led' || x.code === 'switch_1');
                if(statusObj) {
                    document.getElementById(`sw-${id}`).checked = statusObj.value;
                    updateVisual(id, statusObj.value);
                }
            }
        }

        function showColor(id) {
            const p = document.getElementById(`pk-${id}`);
            p.classList.toggle('hidden');
            if(!pickers[id]) {
                pickers[id] = new iro.ColorPicker(`#pk-${id}`, { width: 150, layout: [{ component: iro.ui.Wheel }] });
                pickers[id].on('input:end', (c) => {
                    sendCmd(id, 'work_mode', 'colour');
                    sendCmd(id, 'colour_data_v2', { h: Math.round(c.hsv.h), s: Math.round(c.hsv.s * 10), v: Math.round(c.hsv.v * 10) });
                });
            }
        }

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = 'toast'; t.innerText = msg;
            container.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>
</html>
