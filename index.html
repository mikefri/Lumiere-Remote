<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumeire X - Smart View</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    <style>
        body { background: #0f172a; color: white; font-family: 'Inter', sans-serif; }
        
        /* Carte Standard */
        .glass { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(12px); 
            border-radius: 28px; 
            border: 1px solid rgba(255,255,255,0.05); 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* √âtat Allum√© (Lueur bleue) */
        .is-on { 
            border-color: rgba(56, 189, 248, 0.5); 
            box-shadow: 0 0 25px rgba(56, 189, 248, 0.15); 
            transform: translateY(-2px);
        }

        /* √âtat HORS-LIGNE (Flou et gris√©) */
        .card-offline {
            opacity: 0.4;
            filter: grayscale(0.8) blur(1px);
            background: rgba(15, 23, 42, 0.4); /* Plus sombre */
            border: 1px dashed rgba(255,255,255,0.1);
            pointer-events: none; /* D√©sactive les clics */
            transform: scale(0.98);
        }

        .status-badge {
            font-size: 9px;
            font-weight: 900;
            padding: 4px 10px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input[type="range"] { -webkit-appearance: none; height: 8px; border-radius: 5px; background: #334155; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; border-radius: 50%; background: white; border: 3px solid #38bdf8; cursor: pointer; }
    </style>
</head>
<body class="p-4 pb-24">

    <header class="max-w-md mx-auto py-8 flex justify-between items-center">
        <div>
            <h1 class="text-4xl font-black italic tracking-tighter bg-gradient-to-br from-sky-400 to-blue-600 bg-clip-text text-transparent">LUMEIRE X</h1>
            <p id="global-status" class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Scan du r√©seau...</p>
        </div>
        <div class="flex gap-2">
            <button onclick="masterOff(this)" class="p-3 glass border border-red-500/20 text-red-500 active:scale-90 transition shadow-lg shadow-red-900/20">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
            </button>
            <button onclick="loadDevices()" class="p-3 glass border border-white/10 text-sky-400 active:rotate-180 transition-all duration-500">
                <svg id="refresh-icon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
            </button>
        </div>
    </header>

    <main id="container" class="max-w-md mx-auto space-y-6"></main>

    <script>
        let devicesCache = [];
        let pickers = {};

        window.onload = () => {
            if(localStorage.getItem('tuya_id')) loadDevices();
        };

        async function api(body) {
            const res = await fetch('/api/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    ...body, 
                    accessId: localStorage.getItem('tuya_id'), 
                    accessSecret: localStorage.getItem('tuya_secret') 
                })
            });
            return res.json();
        }

        async function loadDevices() {
            const statusLabel = document.getElementById('global-status');
            const res = await api({ action: 'listDevices' });
            if(res.success) {
                devicesCache = res.result;
                statusLabel.innerText = `${devicesCache.length} APPAREILS D√âTECT√âS`;
                document.getElementById('container').innerHTML = devicesCache.map(d => render(d)).join('');
                devicesCache.forEach(d => { if(d.online) syncStatus(d.id); });
            }
        }

        async function syncStatus(id) {
            const res = await api({ action: 'getStatus', deviceId: id });
            if(res.success && res.result) {
                const s = res.result;
                const isOn = s.find(x => x.code === 'switch_led')?.value;
                const br = s.find(x => x.code === 'bright_value_v2')?.value;
                const tp = s.find(x => x.code === 'temp_value_v2')?.value;

                const sw = document.getElementById(`sw-${id}`);
                if(sw) sw.checked = isOn;
                if(br) document.getElementById(`br-${id}`).value = br;
                if(tp) document.getElementById(`tp-${id}`).value = tp;
                updateCardVisual(id, isOn);
            }
        }

        function render(d) {
            const offlineClass = !d.online ? 'card-offline' : '';
            return `
            <div class="glass p-6 ${offlineClass}" id="card-${d.id}">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 class="font-bold text-lg">${d.name}</h3>
                        <span class="status-badge ${d.online ? 'bg-green-500/10 text-green-500' : 'bg-red-500/10 text-red-500'}">
                            ${d.online ? '‚óè Connect√©' : '‚óã Hors-ligne'}
                        </span>
                    </div>
                    ${d.online ? `
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="sw-${d.id}" onchange="toggle('${d.id}', this.checked)" class="sr-only peer">
                        <div class="w-14 h-7 bg-slate-700 rounded-full peer peer-checked:bg-sky-500 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-7"></div>
                    </label>` : ''}
                </div>

                <div class="space-y-6">
                    <input type="range" id="br-${d.id}" min="10" max="1000" class="w-full" onchange="sendCmd('${d.id}','bright_value_v2',parseInt(this.value))">
                    <input type="range" id="tp-${d.id}" min="0" max="1000" class="w-full bg-gradient-to-r from-orange-400 via-white to-blue-400" onchange="sendCmd('${d.id}','temp_value_v2',parseInt(this.value))">
                </div>

                <div id="pk-${d.id}" class="hidden flex justify-center py-4"></div>

                <div class="mt-6 flex gap-2">
                    <button onclick="resetWhite('${d.id}')" class="flex-1 py-3 bg-white/5 rounded-xl text-[9px] font-black uppercase tracking-widest border border-white/10">‚ö™ Pur Blanc</button>
                    <button onclick="toggleColor('${d.id}')" class="flex-1 py-3 bg-sky-500/5 text-sky-400 rounded-xl text-[9px] font-black uppercase tracking-widest border border-sky-500/10">üåà Couleur</button>
                </div>
            </div>`;
        }

        function updateCardVisual(id, isOn) {
            const card = document.getElementById(`card-${id}`);
            if(card && !card.classList.contains('card-offline')) {
                if(isOn) card.classList.add('is-on');
                else card.classList.remove('is-on');
            }
        }

        async function toggle(id, state) {
            updateCardVisual(id, state);
            await sendCmd(id, 'switch_led', state);
        }

        async function sendCmd(deviceId, code, value) {
            return await api({ action: 'send', deviceId, code, value });
        }

        async function resetWhite(id) {
            await sendCmd(id, 'work_mode', 'white');
            await sendCmd(id, 'bright_value_v2', 1000);
            await sendCmd(id, 'temp_value_v2', 500);
            syncStatus(id);
        }

        async function masterOff(btn) {
            if(!confirm("Tout √©teindre ?")) return;
            devicesCache.forEach(async d => {
                if(d.online) {
                    await sendCmd(d.id, 'switch_led', false);
                    const sw = document.getElementById(`sw-${d.id}`);
                    if(sw) sw.checked = false;
                    updateCardVisual(d.id, false);
                }
            });
        }

        function toggleColor(id) {
            const p = document.getElementById(`pk-${id}`);
            p.classList.toggle('hidden');
            if(!pickers[id]) {
                pickers[id] = new iro.ColorPicker(`#pk-${id}`, { width: 160, layout: [{ component: iro.ui.Wheel }] });
                pickers[id].on('input:end', (c) => {
                    sendCmd(id, 'work_mode', 'colour');
                    sendCmd(id, 'colour_data_v2', { h: c.hsv.h, s: c.hsv.s * 10, v: c.hsv.v * 10 });
                });
            }
        }
    </script>
</body>
</html>
