<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumiere Remote</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    <style>
        body { background: #0b0f1a; color: white; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(12px); border-radius: 32px; border: 1px solid rgba(255,255,255,0.05); transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* État Allumé : Lueur néon */
        .is-on { border-color: rgba(56, 189, 248, 0.5); box-shadow: 0 0 30px rgba(56, 189, 248, 0.15); background: rgba(30, 41, 59, 0.9); }
        .is-on h3 { color: #38bdf8; }

        /* État Hors-ligne : Grisé */
        .is-offline { opacity: 0.4; filter: grayscale(1); pointer-events: none; }
        
        .status-badge { font-size: 9px; font-weight: 800; padding: 4px 10px; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.05em; }
        .badge-online { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .badge-offline { background: rgba(239, 68, 68, 0.1); color: #ef4444; }

        input[type="range"] { -webkit-appearance: none; height: 6px; border-radius: 10px; background: #1e293b; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: white; border: 3px solid #38bdf8; cursor: pointer; box-shadow: 0 0 10px rgba(56, 189, 248, 0.5); }
    </style>
</head>
<body class="p-6 pb-24">

    <header class="max-w-md mx-auto mb-10 flex justify-between items-center">
        <div>
            <h1 class="text-4xl font-black italic tracking-tighter bg-gradient-to-r from-sky-400 to-blue-500 bg-clip-text text-transparent">Lumiere Remote</h1>
            <div class="flex items-center gap-2 mt-1">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <p id="global-info" class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Synchronisation live...</p>
            </div>
        </div>
        <button onclick="fetchAllStatesWithAnim(this)" class="group p-3 bg-white/5 border border-white/10 rounded-2xl hover:bg-white/10 hover:border-sky-500/50 transition-all duration-300 shadow-lg shadow-black/20">
    <svg id="refresh-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-sky-400 group-hover:text-sky-300 transition-transform duration-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
    </svg>
</button>
    </header>

    <main id="device-container" class="max-w-md mx-auto space-y-6">
        </main>

    <script>
        let devices = [];
        let pickers = {};

        async function api(body) {
            const res = await fetch('/api/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    ...body, 
                    accessId: localStorage.getItem('tuya_id'), 
                    accessSecret: localStorage.getItem('tuya_secret') 
                })
            });
            return res.json();
        }

        async function init() {
            const res = await api({ action: 'listDevices' });
            if(res.success) {
                devices = res.result;
                const container = document.getElementById('device-container');
                container.innerHTML = devices.map(d => renderCard(d)).join('');
                fetchAllStates();
            }
        }

        function renderCard(d) {
            return `
            <div class="glass p-8 ${!d.online ? 'is-offline' : ''}" id="card-${d.id}">
                <div class="flex justify-between items-start mb-8">
                    <div>
                        <div class="mb-2">
                            <span class="status-badge ${d.online ? 'badge-online' : 'badge-offline'}">
                                ${d.online ? '● Online' : '● Offline'}
                            </span>
                            <span id="label-sw-${d.id}" class="status-badge ml-1 bg-slate-800 text-slate-400">Sync...</span>
                        </div>
                        <h3 class="font-black text-2xl transition-colors">${d.name}</h3>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="sw-${d.id}" onchange="togglePower('${d.id}', this.checked)" class="sr-only peer">
                        <div class="w-14 h-7 bg-slate-800 rounded-full peer peer-checked:bg-sky-500 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-7 shadow-inner"></div>
                    </label>
                </div>

                <div class="space-y-8">
                    <div>
                        <div class="flex justify-between text-[10px] font-bold text-slate-500 uppercase mb-3">Luminosité <span id="val-br-${d.id}">-</span></div>
                        <input type="range" id="br-${d.id}" min="10" max="1000" class="w-full" onchange="sendCmd('${d.id}','bright_value_v2',parseInt(this.value))">
                    </div>
                    <div>
                        <div class="flex justify-between text-[10px] font-bold text-slate-500 uppercase mb-3">Température <span id="val-tp-${d.id}">-</span></div>
                        <input type="range" id="tp-${d.id}" min="0" max="1000" class="w-full bg-gradient-to-r from-orange-500 via-white to-sky-400 rounded-lg" onchange="sendCmd('${d.id}','temp_value_v2',parseInt(this.value))">
                    </div>
                </div>

                <div id="pk-${d.id}" class="hidden flex justify-center py-6 mt-4 border-t border-white/5"></div>

                <div class="mt-8 flex gap-3">
                    <button onclick="resetWhite('${d.id}')" class="flex-1 py-4 bg-white/5 rounded-2xl text-[10px] font-black uppercase tracking-widest border border-white/5 hover:bg-white hover:text-black transition">Pur Blanc</button>
                    <button onclick="togglePicker('${d.id}')" class="flex-1 py-4 bg-sky-500/10 text-sky-400 rounded-2xl text-[10px] font-black uppercase border border-sky-500/20">Couleur</button>
                </div>
            </div>`;
        }

        async function fetchAllStates() {
            document.getElementById('global-info').innerText = "Mise à jour...";
            for (const d of devices) {
                if (!d.online) continue;
                const res = await api({ action: 'getStatus', deviceId: d.id });
                if(res.success) {
                    const s = res.result;
                    const isOn = s.find(x => x.code === 'switch_led')?.value;
                    const br = s.find(x => x.code === 'bright_value_v2')?.value;
                    const tp = s.find(x => x.code === 'temp_value_v2')?.value;

                    // Update UI elements
                    document.getElementById(`sw-${d.id}`).checked = isOn;
                    document.getElementById(`br-${d.id}`).value = br || 1000;
                    document.getElementById(`tp-${d.id}`).value = tp || 500;
                    document.getElementById(`val-br-${d.id}`).innerText = Math.round((br || 1000) / 10) + '%';
                    document.getElementById(`val-tp-${d.id}`).innerText = Math.round((tp || 500) / 10) + '%';
                    
                    updateCardStyle(d.id, isOn);
                }
            }
            document.getElementById('global-info').innerText = "Système à jour";
        }

        function updateCardStyle(id, isOn) {
            const card = document.getElementById(`card-${id}`);
            const label = document.getElementById(`label-sw-${id}`);
            if(isOn) {
                card.classList.add('is-on');
                label.innerText = "Allumé";
                label.className = "status-badge ml-1 bg-sky-500/20 text-sky-400";
            } else {
                card.classList.remove('is-on');
                label.innerText = "Éteint";
                label.className = "status-badge ml-1 bg-slate-800 text-slate-500";
            }
        }

        async function togglePower(id, state) {
            updateCardStyle(id, state);
            await sendCmd(id, 'switch_led', state);
        }

        async function sendCmd(deviceId, code, value) {
            return await api({ action: 'send', deviceId, code, value });
        }

        async function resetWhite(id) {
            await sendCmd(id, 'work_mode', 'white');
            await sendCmd(id, 'bright_value_v2', 1000);
            await sendCmd(id, 'temp_value_v2', 500);
            fetchAllStates(); // Force refresh visuel
        }

        function togglePicker(id) {
            const p = document.getElementById(`pk-${id}`);
            p.classList.toggle('hidden');
            if(!pickers[id]) {
                pickers[id] = new iro.ColorPicker(`#pk-${id}`, { width: 180, layout: [{ component: iro.ui.Wheel }] });
                pickers[id].on('input:end', (c) => {
                    sendCmd(id, 'work_mode', 'colour');
                    sendCmd(id, 'colour_data_v2', { h: c.hsv.h, s: c.hsv.s * 10, v: c.hsv.v * 10 });
                });
            }
        }
        async function fetchAllStatesWithAnim(btn) {
    const icon = btn.querySelector('#refresh-icon');
    
    // On fait tourner l'icône
    icon.classList.add('rotate-180');
    
    // On appelle la fonction de mise à jour
    await fetchAllStates();
    
    // On remet l'icône en place après un petit délai pour l'effet visuel
    setTimeout(() => {
        icon.classList.remove('rotate-180');
    }, 500);
}

        // Auto-refresh toutes les 10 secondes
        setInterval(fetchAllStates, 10000);
        
        window.onload = init;
    </script>
</body>
</html>
