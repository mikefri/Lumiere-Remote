<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumeire - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #F1F5F9; font-family: sans-serif; }
        .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 30px; border: 1px solid white; }
        .slider { -webkit-appearance: none; width: 100%; height: 10px; border-radius: 10px; background: #E2E8F0; outline: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; border-radius: 50%; background: white; border: 3px solid #3B82F6; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .bg-temp { background: linear-gradient(to right, #FF9500, #FFFFFF, #007AFF); }
    </style>
</head>
<body class="pb-20">
    <div class="max-w-md mx-auto px-6">
        <header class="py-10 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-black text-slate-900">Lumeire</h1>
                <p id="status" class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">Initialisation...</p>
            </div>
            <div class="flex gap-2">
                <button onclick="allOff()" class="p-3 bg-red-100 text-red-600 rounded-2xl active:scale-90 transition">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </button>
                <button onclick="loadDevices()" class="p-3 bg-white text-slate-600 rounded-2xl shadow-sm active:rotate-180 transition-all duration-500">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                </button>
            </div>
        </header>

        <details class="mb-8"><summary class="text-center text-[10px] text-slate-400 cursor-pointer mb-2">CLÉS API</summary>
            <div class="bg-white p-4 rounded-2xl space-y-2">
                <input id="accId" type="text" placeholder="Access ID" class="w-full p-2 border rounded-lg text-sm">
                <input id="accSec" type="password" placeholder="Access Secret" class="w-full p-2 border rounded-lg text-sm">
                <button onclick="save()" class="w-full bg-slate-800 text-white py-2 rounded-xl text-sm">Enregistrer</button>
            </div>
        </details>

        <div id="device-list" class="space-y-6"></div>
    </div>

    <script>
        let devicesCache = [];

        window.onload = () => {
            document.getElementById('accId').value = localStorage.getItem('tuya_id') || '';
            document.getElementById('accSec').value = localStorage.getItem('tuya_secret') || '';
            if(localStorage.getItem('tuya_id')) loadDevices();
        };

        function save() {
            localStorage.setItem('tuya_id', document.getElementById('accId').value);
            localStorage.setItem('tuya_secret', document.getElementById('accSec').value);
            loadDevices();
        }

        async function api(body) {
            const res = await fetch('/api/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...body, accessId: localStorage.getItem('tuya_id'), accessSecret: localStorage.getItem('tuya_secret') })
            });
            return res.json();
        }

        async function loadDevices() {
            const container = document.getElementById('device-list');
            const data = await api({ action: 'listDevices' });
            if (data.success) {
                devicesCache = data.result;
                document.getElementById('status').innerText = `${devicesCache.length} lampes détectées`;
                container.innerHTML = devicesCache.map(dev => render(dev)).join('');
                devicesCache.forEach(dev => sync(dev.id));
            }
        }

        async function sync(deviceId) {
            const data = await api({ action: 'getStatus', deviceId });
            if (data.success) {
                const s = data.result;
                const isOn = s.find(x => x.code === 'switch_led')?.value;
                const br = s.find(x => x.code === 'bright_value_v2')?.value;
                const tp = s.find(x => x.code === 'temp_value_v2')?.value;

                if (document.getElementById(`sw-${deviceId}`)) document.getElementById(`sw-${deviceId}`).checked = isOn;
                if (document.getElementById(`br-${deviceId}`)) document.getElementById(`br-${deviceId}`).value = br;
                if (document.getElementById(`tp-${deviceId}`)) document.getElementById(`tp-${deviceId}`).value = tp;
                updateUI(deviceId, isOn);
            }
        }

        function render(dev) {
            return `
                <div class="glass p-8 shadow-xl shadow-slate-200/50">
                    <div class="flex justify-between items-center mb-8">
                        <div id="ico-${dev.id}" class="p-4 bg-slate-100 rounded-2xl text-slate-300">
                            <svg class="h-8 w-8" fill="currentColor" viewBox="0 0 20 20"><path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1h4v1a2 2 0 11-4 0zM12 14c.015-.34.208-.646.477-.859a4 4 0 10-4.954 0c.27.213.462.519.477.859h4z"/></svg>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="sw-${dev.id}" onchange="toggle('${dev.id}', this.checked)" class="sr-only peer">
                            <div class="w-16 h-8 bg-slate-200 rounded-full peer peer-checked:bg-blue-600 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:after:translate-x-8"></div>
                        </label>
                    </div>
                    <h3 class="font-bold text-lg mb-6">${dev.name}</h3>
                    <div class="space-y-6">
                        <input type="range" id="br-${dev.id}" min="10" max="1000" class="slider" onchange="cmd('${dev.id}','bright_value_v2',parseInt(this.value))">
                        <input type="range" id="tp-${dev.id}" min="0" max="1000" class="slider bg-temp" onchange="cmd('${dev.id}','temp_value_v2',parseInt(this.value))">
                    </div>
                </div>`;
        }

        function updateUI(id, state) {
            const ico = document.getElementById(`ico-${id}`);
            if (ico) {
                ico.className = state ? "p-4 bg-yellow-100 rounded-2xl text-yellow-500" : "p-4 bg-slate-100 rounded-2xl text-slate-300";
            }
        }

        async function toggle(id, state) { updateUI(id, state); await cmd(id, 'switch_led', state); }
        async function cmd(deviceId, code, value) { await api({ action: 'send', deviceId, code, value }); }
        async function allOff() { for (const d of devicesCache) { toggle(d.id, false); if(document.getElementById(`sw-${d.id}`)) document.getElementById(`sw-${d.id}`).checked = false; } }
    </script>
</body>
</html>
