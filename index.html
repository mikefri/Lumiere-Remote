<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumeire X - Quantum Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; }
        body { background: var(--bg); color: white; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .neon-border { border: 1px solid rgba(56, 189, 248, 0.2); box-shadow: 0 0 20px rgba(56, 189, 248, 0.1); }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border-radius: 30px; }
        
        /* Animations */
        @keyframes pulse-glow { 0% { box-shadow: 0 0 5px #38bdf8; } 50% { box-shadow: 0 0 20px #38bdf8; } 100% { box-shadow: 0 0 5px #38bdf8; } }
        .active-glow { animation: pulse-glow 2s infinite; border-color: #38bdf8; }
        
        /* Custom Slider */
        input[type="range"] { -webkit-appearance: none; height: 10px; border-radius: 5px; background: #334155; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 25px; height: 25px; border-radius: 50%; background: white; cursor: pointer; border: 4px solid #38bdf8; }
    </style>
</head>
<body class="p-4 pb-24">

    <header class="max-w-md mx-auto py-8 text-center">
        <h1 class="text-5xl font-black tracking-tighter italic bg-gradient-to-r from-sky-400 to-indigo-500 bg-clip-text text-transparent">LUMEIRE X</h1>
        <div id="global-stats" class="text-[10px] text-sky-500 font-bold uppercase tracking-[0.3em] mt-2">Quantum Link Active</div>
    </header>

    <div class="max-w-md mx-auto grid grid-cols-2 gap-4 mb-8">
        <button onclick="allAction(true)" class="glass p-6 text-center neon-border hover:bg-sky-500/10 transition">
            <span class="block text-2xl mb-1">üîÜ</span>
            <span class="text-[10px] font-bold uppercase">All On</span>
        </button>
        <button onclick="allAction(false)" class="glass p-6 text-center border border-red-500/20 hover:bg-red-500/10 transition">
            <span class="block text-2xl mb-1">üåë</span>
            <span class="text-[10px] font-bold uppercase">All Off</span>
        </button>
    </div>

    <main id="device-container" class="max-w-md mx-auto space-y-8">
        <div class="glass p-8 animate-pulse text-center text-slate-500">Scanning frequency...</div>
    </main>

    <button onclick="document.getElementById('config-panel').classList.toggle('hidden')" class="fixed bottom-6 right-6 w-14 h-14 bg-sky-500 rounded-full shadow-lg flex items-center justify-center text-2xl z-50">‚öôÔ∏è</button>
    
    <div id="config-panel" class="fixed inset-0 bg-slate-900/95 z-[60] hidden p-10 flex flex-col justify-center">
        <h2 class="text-2xl font-bold mb-6">API Core Keys</h2>
        <input id="tuya_id" type="text" placeholder="Access ID" class="w-full p-4 mb-4 bg-slate-800 rounded-xl outline-none border border-slate-700 focus:border-sky-500">
        <input id="tuya_secret" type="password" placeholder="Access Secret" class="w-full p-4 mb-8 bg-slate-800 rounded-xl outline-none border border-slate-700 focus:border-sky-500">
        <button onclick="saveConfig()" class="w-full py-4 bg-sky-500 rounded-xl font-bold uppercase">Link Systems</button>
        <button onclick="document.getElementById('config-panel').classList.add('hidden')" class="mt-4 text-slate-500">Close</button>
    </div>

    <script>
        let devices = [];
        let colorPickers = {};

        window.onload = () => {
            document.getElementById('tuya_id').value = localStorage.getItem('tuya_id') || '';
            document.getElementById('tuya_secret').value = localStorage.getItem('tuya_secret') || '';
            if(localStorage.getItem('tuya_id')) refresh();
        };

        function saveConfig() {
            localStorage.setItem('tuya_id', document.getElementById('tuya_id').value);
            localStorage.setItem('tuya_secret', document.getElementById('tuya_secret').value);
            location.reload();
        }

        async function request(body) {
            const res = await fetch('/api/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...body, accessId: localStorage.getItem('tuya_id'), accessSecret: localStorage.getItem('tuya_secret') })
            });
            return res.json();
        }

        async function refresh() {
            const data = await request({ action: 'listDevices' });
            if(data.success) {
                devices = data.result;
                render();
            }
        }

        function render() {
            const container = document.getElementById('device-container');
            container.innerHTML = devices.map(d => `
                <div class="glass p-8 neon-border relative group overflow-hidden" id="card-${d.id}">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="text-xl font-black">${d.name}</h3>
                            <p class="text-[9px] text-sky-400 tracking-[0.2em] font-bold uppercase">${d.category} | ONLINE</p>
                        </div>
                        <button onclick="toggle('${d.id}')" id="btn-${d.id}" class="w-16 h-8 rounded-full bg-slate-700 relative transition-all">
                            <div id="dot-${d.id}" class="w-6 h-6 bg-white rounded-full absolute top-1 left-1 transition-all"></div>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <div class="relative">
                            <label class="text-[9px] font-bold text-slate-500 uppercase block mb-2">Intensity</label>
                            <input type="range" id="br-${d.id}" min="10" max="1000" class="w-full" onchange="send('${d.id}', 'bright_value_v2', parseInt(this.value))">
                        </div>
                        <div class="relative">
                            <label class="text-[9px] font-bold text-slate-500 uppercase block mb-2">Kelvin Scale</label>
                            <input type="range" id="tp-${d.id}" min="0" max="1000" class="w-full bg-gradient-to-r from-orange-500 via-white to-blue-500" onchange="send('${d.id}', 'temp_value_v2', parseInt(this.value))">
                        </div>
                    </div>

                    <div class="mt-8 flex justify-between items-center gap-4">
                         <div id="picker-${d.id}" class="hidden py-4"></div>
                         <button onclick="togglePicker('${d.id}')" class="flex-1 py-3 glass border border-sky-500/30 text-[10px] font-bold uppercase tracking-widest hover:bg-sky-500 hover:text-white transition">Color Engine</button>
                         <button onclick="setMode('${d.id}', 'music')" class="px-6 py-3 glass border border-purple-500/30 text-[10px] font-bold uppercase text-purple-400 hover:bg-purple-500 hover:text-white transition">Disco</button>
                    </div>

                    <div class="mt-6 pt-6 border-t border-slate-700/50 flex gap-2 overflow-x-auto no-scrollbar">
                        ${[1, 2, 3, 4].map(s => `<button onclick="sendScene('${d.id}', ${s})" class="px-4 py-2 bg-slate-800 rounded-lg text-[9px] font-bold uppercase hover:bg-sky-900 transition">Scene ${s}</button>`).join('')}
                    </div>
                </div>
            `).join('');
            
            // Sync status after render
            devices.forEach(d => sync(d.id));
        }

        async function sync(id) {
            const res = await request({ action: 'getStatus', deviceId: id });
            if(res.success) {
                const s = res.result;
                const isOn = s.find(x => x.code === 'switch_led')?.value;
                document.getElementById(`br-${id}`).value = s.find(x => x.code === 'bright_value_v2')?.value || 500;
                document.getElementById(`tp-${id}`).value = s.find(x => x.code === 'temp_value_v2')?.value || 500;
                updateVisuals(id, isOn);
            }
        }

        function updateVisuals(id, isOn) {
            const dot = document.getElementById(`dot-${id}`);
            const btn = document.getElementById(`btn-${id}`);
            const card = document.getElementById(`card-${id}`);
            if(isOn) {
                dot.style.transform = 'translateX(32px)';
                btn.classList.replace('bg-slate-700', 'bg-sky-500');
                card.classList.add('active-glow');
            } else {
                dot.style.transform = 'translateX(0px)';
                btn.classList.replace('bg-sky-500', 'bg-slate-700');
                card.classList.remove('active-glow');
            }
        }

        async function toggle(id) {
            const btn = document.getElementById(`btn-${id}`);
            const currentState = btn.classList.contains('bg-sky-500');
            updateVisuals(id, !currentState);
            await send(id, 'switch_led', !currentState);
            if (window.navigator.vibrate) window.navigator.vibrate(50);
        }

        async function togglePicker(id) {
            const p = document.getElementById(`picker-${id}`);
            p.classList.toggle('hidden');
            if(!colorPickers[id]) {
                colorPickers[id] = new iro.ColorPicker(`#picker-${id}`, { width: 150, layout: [{ component: iro.ui.Wheel }] });
                colorPickers[id].on('input:end', (color) => {
                    send(id, 'work_mode', 'colour');
                    send(id, 'colour_data_v2', { h: color.hsv.h, s: color.hsv.s * 10, v: color.hsv.v * 10 });
                });
            }
        }

        async function send(deviceId, code, value) {
            return await request({ action: 'send', deviceId, code, value });
        }

        async function allAction(state) {
            for(const d of devices) {
                toggle(d.id, state);
                await send(d.id, 'switch_led', state);
            }
        }

        async function sendScene(id, num) {
            await send(id, 'work_mode', 'scene');
            // Simplified scene command
            alert("Scene " + num + " activated for " + id);
        }
    </script>
</body>
</html>
