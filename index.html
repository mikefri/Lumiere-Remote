<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lumiere Remote Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    <style>
        body { background: radial-gradient(at top left, #e0f2fe, #f1f5f9 50%, #fafaf9); color: #334155; font-family: 'Inter', sans-serif; min-height: 100vh; }
        .glass { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(15px); border-radius: 32px; border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 15px 35px rgba(148, 163, 184, 0.15); transition: all 0.4s ease; }
        
        /* [x] Feedback visuel : Glow et Bordure */
        .is-on { 
            background: rgba(255, 255, 255, 0.9) !important; 
            border-color: #38bdf8 !important; 
            box-shadow: 0 0 25px rgba(56, 189, 248, 0.3) !important;
            transform: translateY(-2px);
        }

        /* [x] Tri visuel : Offline grisé */
        .card-offline { opacity: 0.5; filter: grayscale(0.8); pointer-events: none; }
        
        .label-text { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; color: #64748b; }
        
        input[type="range"] { -webkit-appearance: none; height: 8px; border-radius: 5px; background: #d1dce8; outline: none; width: 100%; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%; background: white; border: 4px solid #38bdf8; cursor: pointer; }
    </style>
</head>
<body class="p-4 flex justify-center items-start">
    
    <div id="custom-confirm" class="fixed inset-0 z-[10000] hidden flex items-center justify-center p-6 bg-slate-950/60 backdrop-blur-sm">
        <div class="glass p-8 max-w-xs w-full text-center border-sky-500/30">
            <h3 class="text-xl font-black mb-6">Tout éteindre ?</h3>
            <div class="flex gap-3">
                <button id="confirm-yes" class="flex-1 py-4 bg-red-500 text-white rounded-2xl font-black uppercase text-[10px]">Confirmer</button>
                <button id="confirm-no" class="flex-1 py-4 bg-slate-100 rounded-2xl font-black uppercase text-[10px]">Annuler</button>
            </div>
        </div>
    </div>

    <div class="w-full max-w-xl">
        <header class="py-8 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-black italic tracking-tighter bg-gradient-to-br from-sky-500 to-blue-700 bg-clip-text text-transparent">Lumiere X</h1>
                <p class="label-text mt-1 text-sky-500">Contrôle Intelligent</p>
            </div>
            <div class="flex gap-2">
                <button onclick="masterOff()" class="p-4 glass text-red-500 active:scale-90 transition shadow-lg border-red-500/20">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                </button>
                <button onclick="loadDevices()" class="p-4 glass text-sky-400 active:rotate-180 transition shadow-lg">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                </button>
            </div>
        </header>

        <main id="container" class="space-y-6"></main>
    </div>

    <script>
        let devicesCache = [];
        let pickers = {};
        // [x] Mémoire d'état pour chaque lampe
        let deviceStates = {};

        async function api(body) {
            try {
                const res = await fetch('/api/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...body, accessId: localStorage.getItem('tuya_id'), accessSecret: localStorage.getItem('tuya_secret') })
                });
                return await res.json();
            } catch (e) { return { success: false }; }
        }

        async function loadDevices() {
            const res = await api({ action: 'listDevices' });
            if(res.success) {
                // [x] Tri automatique (Online haut) + [x] Tri alphabétique
                devicesCache = res.result.sort((a, b) => {
                    if (a.online !== b.online) return a.online ? -1 : 1;
                    return a.name.localeCompare(b.name);
                });
                
                document.getElementById('container').innerHTML = devicesCache.map(d => render(d)).join('');
                devicesCache.forEach(d => { if(d.online) syncStatus(d.id); });
            }
        }

        function render(d) {
            // [x] Gestion Hybride : On détecte si c'est une ampoule (dj/dd) ou un switch
            const isLight = d.category === 'dj' || d.category === 'dd' || d.name.toLowerCase().includes('lum');
            
            return `
            <div class="glass p-8 ${!d.online ? 'card-offline' : ''}" id="card-${d.id}">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 class="font-black text-xl mb-2">${d.name}</h3>
                        <div class="flex gap-2">
                            <span class="text-[9px] font-black px-2 py-1 rounded bg-black/5 uppercase ${d.online ? 'text-blue-500' : 'text-slate-400'}">
                                ${d.online ? '● Réseau OK' : '○ Hors-ligne'}
                            </span>
                            <span id="badge-status-${d.id}" class="text-[9px] font-black px-2 py-1 rounded bg-black/5 uppercase text-slate-400">...</span>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="sw-${d.id}" onchange="universalToggle('${d.id}', this.checked)" class="sr-only peer">
                        <div class="w-14 h-7 bg-slate-200 rounded-full peer peer-checked:bg-sky-500 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-7 shadow-inner"></div>
                    </label>
                </div>

                ${isLight ? `
                <div class="space-y-6 border-t border-black/5 pt-6">
                    <div class="space-y-2">
                        <span class="label-text">Intensité</span>
                        <input type="range" id="br-${d.id}" min="10" max="1000" onchange="handleBrightness('${d.id}', this.value)">
                    </div>
                    <div class="space-y-2">
                        <span class="label-text">Température Blanc</span>
                        <input type="range" id="tp-${d.id}" min="0" max="1000" class="bg-gradient-to-r from-orange-300 via-white to-sky-300" onchange="sendCmd('${d.id}','temp_value_v2',parseInt(this.value))">
                    </div>
                    <div id="pk-${d.id}" class="hidden flex justify-center py-4"></div>
                    <div class="flex gap-2">
                        <button onclick="setForcedWhite('${d.id}')" class="flex-1 py-3 bg-white border border-slate-200 rounded-2xl text-[9px] font-black uppercase">Mode Blanc</button>
                        <button onclick="togglePicker('${d.id}')" class="flex-1 py-3 bg-sky-500/10 text-sky-600 rounded-2xl text-[9px] font-black uppercase">Couleurs</button>
                    </div>
                </div>` : ''}
            </div>`;
        }

        async function syncStatus(id) {
            const res = await api({ action: 'getStatus', deviceId: id });
            if(res.success && res.result) {
                const s = res.result;
                // Stockage mémoire [x]
                deviceStates[id] = {
                    work_mode: s.find(x => x.code === 'work_mode')?.value || 'white',
                    colour_data: s.find(x => x.code === 'colour_data_v2')?.value
                };

                const sw = s.find(x => x.code === 'switch_led' || x.code === 'switch_1');
                if(sw) {
                    document.getElementById(`sw-${id}`).checked = sw.value;
                    updateVisual(id, sw.value);
                }
                const br = s.find(x => x.code === 'bright_value_v2')?.value;
                if(br && document.getElementById(`br-${id}`)) document.getElementById(`br-${id}`).value = br;
            }
        }

        function updateVisual(id, isOn) {
            const card = document.getElementById(`card-${id}`);
            const badge = document.getElementById(`badge-status-${id}`);
            if(!card || !badge) return;
            if(isOn) {
                card.classList.add('is-on');
                badge.innerText = "● Allumé";
                badge.className = "text-[9px] font-black px-2 py-1 rounded bg-sky-50 uppercase text-sky-500";
            } else {
                card.classList.remove('is-on');
                badge.innerText = "○ Éteint";
                badge.className = "text-[9px] font-black px-2 py-1 rounded bg-black/5 uppercase text-slate-400";
            }
        }

        async function universalToggle(id, state) {
            updateVisual(id, state);
            const dev = devicesCache.find(d => d.id === id);
            const code = (dev.category === 'dj' || dev.category === 'dd' || dev.name.toLowerCase().includes('lum')) ? 'switch_led' : 'switch_1';
            await sendCmd(id, code, state);
        }

        // [x] Gestion critique de l'intensité
        async function handleBrightness(id, val) {
            const state = deviceStates[id];
            if (state && state.work_mode === 'colour' && state.colour_data) {
                // Si on est en mode couleur, on modifie la luminosité dans l'objet couleur pour ne pas reset en blanc
                const color = typeof state.colour_data === 'string' ? JSON.parse(state.colour_data) : state.colour_data;
                await sendCmd(id, 'colour_data_v2', { h: color.h, s: color.s, v: parseInt(val) });
            } else {
                await sendCmd(id, 'bright_value_v2', parseInt(val));
            }
        }

        async function setForcedWhite(id) {
            await sendCmd(id, 'work_mode', 'white');
            await sendCmd(id, 'bright_value_v2', 1000);
            deviceStates[id].work_mode = 'white';
            syncStatus(id);
        }

        function togglePicker(id) {
            const p = document.getElementById(`pk-${id}`);
            p.classList.toggle('hidden');
            if(!pickers[id]) {
                pickers[id] = new iro.ColorPicker(`#pk-${id}`, { width: 160, layout: [{ component: iro.ui.Wheel }] });
                pickers[id].on('input:end', (c) => {
                    const data = { h: c.hsv.h, s: c.hsv.s * 10, v: c.hsv.v * 10 };
                    sendCmd(id, 'work_mode', 'colour');
                    sendCmd(id, 'colour_data_v2', data);
                    deviceStates[id].work_mode = 'colour';
                    deviceStates[id].colour_data = data;
                });
            }
        }

        async function sendCmd(deviceId, code, value) { return await api({ action: 'send', deviceId, code, value }); }

        async function masterOff() {
            const modal = document.getElementById('custom-confirm');
            modal.classList.remove('hidden');
            const choice = await new Promise(r => {
                document.getElementById('confirm-yes').onclick = () => r(true);
                document.getElementById('confirm-no').onclick = () => r(false);
            });
            modal.classList.add('hidden');
            if(choice) {
                devicesCache.forEach(d => {
                    if(d.online) {
                        universalToggle(d.id, false);
                        if(document.getElementById(`sw-${d.id}`)) document.getElementById(`sw-${d.id}`).checked = false;
                    }
                });
            }
        }

        window.onload = loadDevices;
    </script>
</body>
</html>
