<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Lumiere Remote</title>
<meta name="description" content="Pilotez vos √©clairages Tuya et Calex avec Lumeire X. Une interface futuriste, rapide et intuitive pour g√©rer vos couleurs, intensit√©s et ambiances.">
<meta name="author" content="Lumeire X Team">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Lumiere Remote">
<meta name="theme-color" content="#0f172a">
<meta name="mobile-web-app-capable" content="yes">

<meta property="og:type" content="website">
<meta property="og:url" content="https://lumiereremot.vercel.app/">
<meta property="og:title" content="Lumiere Remote - Dashboard Domotique Futuriste">
<meta property="og:description" content="Prenez le contr√¥le de votre maison avec style. Interface ultra-fluide pour ampoules connect√©es.">
<meta property="og:image" content="/icon.png">

<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://lumiereremot.vercel.app/">
<meta property="twitter:title" content="Lumiere Remote | Smart IoT Control">
<meta property="twitter:description" content="L'interface ultime pour vos objets connect√©s Tuya. Rapide, √©l√©gante et personnalisable.">
<meta property="twitter:image" content="/icon.png">



    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('PWA pr√™te !', reg))
                .catch(err => console.log('Erreur PWA', err));
        });
    }
</script>
<style>
    body { 
        background: radial-gradient(at top left, #e0f2fe, #f1f5f9 50%, #fafaf9); 
        color: #334155; 
        font-family: 'Inter', sans-serif; 
    }

    /* Style Glassmorphism principal */
    .glass { 
        background: rgba(255, 255, 255, 0.6); 
        backdrop-filter: blur(15px); 
        border-radius: 32px; 
        border: 1px solid rgba(255, 255, 255, 0.8); 
        box-shadow: 0 15px 35px rgba(148, 163, 184, 0.15); 
        transition: all 0.4s ease; 
    }

    /* √âtat quand l'ampoule est allum√©e */
    .is-on { 
        background: rgba(255, 255, 255, 0.9) !important; 
        border-color: #38bdf8 !important; 
        box-shadow: 0 10px 25px rgba(56, 189, 248, 0.15); 
    }

    .card-offline { 
        opacity: 0.5; 
        filter: grayscale(0.9) blur(3px); 
        background: rgba(15, 23, 42, 0.1); /* Ajust√© pour le th√®me clair */
        pointer-events: none; 
    }

    .label-text { 
        font-size: 10px; 
        font-weight: 800; 
        text-transform: uppercase; 
        letter-spacing: 0.1em; 
        color: #64748b; 
    }

    /* Sliders */
    input[type="range"] { 
        -webkit-appearance: none; 
        height: 8px; 
        border-radius: 5px; 
        background: #d1dce8; 
        outline: none; 
    }

    input[type="range"]::-webkit-slider-thumb { 
        -webkit-appearance: none; 
        width: 24px; 
        height: 24px; 
        border-radius: 50%; 
        background: white; 
        border: 4px solid #38bdf8; 
        cursor: pointer; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* Notifications Toast */
    #toast-container { 
        position: fixed; 
        top: 20px; 
        right: 20px; 
        z-index: 9999; 
        display: flex; 
        flex-direction: column; 
        gap: 10px; 
    }

    .toast { 
        background: white; 
        backdrop-filter: blur(10px); 
        border: 1px solid rgba(0,0,0,0.05); 
        color: #334155; 
        padding: 12px 24px; 
        border-radius: 16px; 
        font-size: 14px; 
        font-weight: 600;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        animation: slideIn 0.3s ease-out forwards;
    }

    @keyframes slideIn { 
        from { transform: translateX(100%); opacity: 0; } 
        to { transform: translateX(0); opacity: 1; } 
    }

    .toast-success { border-left: 4px solid #38bdf8; }
    .toast-error { border-left: 4px solid #ef4444; }

    /* Bouton mode couleur */
    .bg-sky-500\/5 { background: rgba(56, 189, 248, 0.1); }
</style>


    
</head>
<body class="p-4 min-h-screen flex justify-center items-start overscroll-behavior-y-contain">
    <div class="glass w-full max-w-xl p-6 border border-white/10 shadow-2xl my-4">
<div id="toast-container"></div>
    <div id="custom-confirm" class="fixed inset-0 z-[10000] hidden flex items-start justify-center p-10 bg-slate-950/60 backdrop-blur-sm">
    <div class="glass p-8 max-w-xs w-full border border-sky-500/30 shadow-2xl scale-95 animate-in fade-in zoom-in duration-300">
        <h3 class="text-xl font-black mb-4 text-center">Tout √©teindre ?</h3>
        <p class="text-slate-400 text-sm text-center mb-8 uppercase tracking-widest font-bold">Action irr√©versible</p>
        <div class="flex gap-3">
            <button id="confirm-yes" class="flex-1 py-3 bg-red-500/20 border border-red-500/50 rounded-xl text-red-500 font-black uppercase text-[10px] hover:bg-red-500 hover:text-white transition">Confirmer</button>
            <button id="confirm-no" class="flex-1 py-3 bg-white/5 border border-white/10 rounded-xl text-white font-black uppercase text-[10px] hover:bg-white/10 transition">Annuler</button>
        </div>
    </div>
</div>
    <header class="max-w-md mx-auto py-8 flex justify-between items-center">
        <div>
            <h1 class="text-4xl font-black italic tracking-tighter bg-gradient-to-br from-sky-400 to-blue-600 bg-clip-text text-transparent">Lumiere Remote</h1>
            <p id="global-status" class="label-text mt-1 text-sky-500 italic">Interface de Contr√¥le</p>
        </div>
        <div class="flex gap-2">
            <button onclick="masterOff(this)" class="p-3 glass border border-red-500/20 text-red-500 active:scale-90 transition shadow-lg">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
            </button>
            <button onclick="loadDevices()" class="p-3 glass border border-white/10 text-sky-400 active:rotate-180 transition-all duration-500 shadow-lg">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
            </button>
        </div>
    </header>

    <section id="config-panel" class="max-w-md mx-auto mb-8 hidden">
        <div class="glass p-6 border-sky-500/30 border">
            <h2 class="label-text mb-4 text-sky-400 text-center text-xs">Premi√®re Connexion : Param√®tres Cloud Tuya</h2>
            <div class="space-y-3">
                <input id="tuya_id" type="text" placeholder="Access ID" class="w-full p-4 bg-slate-900/50 rounded-2xl outline-none text-sm border border-slate-700 focus:border-sky-500 transition-colors">
                <input id="tuya_secret" type="password" placeholder="Access Secret" class="w-full p-4 bg-slate-900/50 rounded-2xl outline-none text-sm border border-slate-700 focus:border-sky-500 transition-colors">
                <button onclick="save()" class="w-full py-4 bg-sky-600 hover:bg-sky-500 rounded-2xl font-black uppercase tracking-widest text-[10px] transition-all">
                    üíæ Enregistrer & Lancer le Scan
                </button>
            </div>
        </div>
    </section>

    <main id="container" class="max-w-md mx-auto space-y-8"></main>

    <footer class="max-w-md mx-auto mt-12 text-center">
        <button onclick="document.getElementById('config-panel').classList.toggle('hidden')" class="label-text opacity-30 hover:opacity-100 transition">Modifier les cl√©s API</button>
    </footer>
</div>
    <script>
        let devicesCache = [];
        let pickers = {};

        window.onload = () => {
            const id = localStorage.getItem('tuya_id');
            const secret = localStorage.getItem('tuya_secret');
            
            if(!id || !secret) {
                document.getElementById('config-panel').classList.remove('hidden');
            } else {
                document.getElementById('tuya_id').value = id;
                document.getElementById('tuya_secret').value = secret;
                loadDevices();
            }
        };

function save() {
    localStorage.setItem('tuya_id', document.getElementById('tuya_id').value);
    localStorage.setItem('tuya_secret', document.getElementById('tuya_secret').value);
    document.getElementById('config-panel').classList.add('hidden');
    showToast("Param√®tres sauvegard√©s !"); // Plus joli que rien du tout
    loadDevices();
}

        async function api(body) {
            const res = await fetch('/api/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    ...body, 
                    accessId: localStorage.getItem('tuya_id'), 
                    accessSecret: localStorage.getItem('tuya_secret') 
                })
            });
            return res.json();
        }

        async function loadDevices() {
            const res = await api({ action: 'listDevices' });
            if(res.success) {
                devicesCache = res.result;
                document.getElementById('container').innerHTML = devicesCache.map(d => render(d)).join('');
                devicesCache.forEach(d => { if(d.online) syncStatus(d.id); });
            }
        }

        async function syncStatus(id) {
            const res = await api({ action: 'getStatus', deviceId: id });
            if(res.success && res.result) {
                const s = res.result;
                const isOn = s.find(x => x.code === 'switch_led')?.value;
                const br = s.find(x => x.code === 'bright_value_v2')?.value;
                const tp = s.find(x => x.code === 'temp_value_v2')?.value;

                if(document.getElementById(`sw-${id}`)) document.getElementById(`sw-${id}`).checked = isOn;
                if(br) document.getElementById(`br-${id}`).value = br;
                if(tp) document.getElementById(`tp-${id}`).value = tp;
                updateVisual(id, isOn);
            }
        }

        function render(d) {
            return `
            <div class="glass p-8 ${!d.online ? 'card-offline' : ''}" id="card-${d.id}">
                <div class="flex justify-between items-start mb-8">
                    <div>
                        <h3 class="font-black text-xl mb-2">${d.name}</h3>
                        <div class="flex gap-1 flex-wrap">
                            <span class="text-[9px] font-black px-2 py-1 rounded bg-white/5 uppercase ${d.online ? 'text-green-500' : 'text-red-500'}">
                                ${d.online ? '‚óè Connect√©' : '‚óã Hors-ligne'}
                            </span>
                            <span id="badge-status-${d.id}" class="text-[9px] font-black px-2 py-1 rounded bg-white/5 uppercase text-slate-400">
                                ...
                            </span>
                        </div>
                    </div>
                    <div class="flex flex-col items-center gap-1">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="sw-${d.id}" onchange="toggle('${d.id}', this.checked)" class="sr-only peer">
                            <div class="w-14 h-7 bg-slate-800 rounded-full peer peer-checked:bg-sky-500 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-7 shadow-inner"></div>
                        </label>
                        <span class="label-text">On/Off</span>
                    </div>
                </div>

                <div class="space-y-8">
                    <div class="space-y-3">
                        <span class="label-text">Intensit√© Lumineuse</span>
                        <input type="range" id="br-${d.id}" min="10" max="1000" class="w-full" onchange="sendCmd('${d.id}','bright_value_v2',parseInt(this.value))">
                    </div>

                    <div class="space-y-3">
                        <span class="label-text">Temp√©rature (Froid/Chaud)</span>
                        <input type="range" id="tp-${d.id}" min="0" max="1000" class="w-full bg-gradient-to-r from-orange-500 via-white to-sky-400" onchange="sendCmd('${d.id}','temp_value_v2',parseInt(this.value))">
                    </div>
                </div>

                <div id="pk-${d.id}" class="hidden flex flex-col items-center py-6 mt-4 border-t border-white/5">
                    <span class="label-text mb-4">Palette de Couleurs</span>
                </div>

                <div class="mt-8 flex gap-3">
                    <button onclick="resetWhite('${d.id}')" class="flex-1 py-4 bg-white/5 rounded-2xl border border-white/10 flex flex-col items-center hover:bg-white/10 transition">
                        <span class="text-lg">‚ö™</span>
                        <span class="label-text mt-1">Mode Blanc</span>
                    </button>
                    <button onclick="toggleColor('${d.id}')" class="flex-1 py-4 bg-sky-500/5 rounded-2xl border border-sky-500/10 flex flex-col items-center hover:bg-sky-500/20 transition">
                        <span class="text-lg">üåà</span>
                        <span class="label-text mt-1 text-sky-400">Couleurs</span>
                    </button>
                </div>
            </div>`;
        }

        function updateVisual(id, isOn) {
            const card = document.getElementById(`card-${id}`);
            const badge = document.getElementById(`badge-status-${id}`);
            if(card && isOn) {
                card.classList.add('is-on');
                badge.innerText = "‚óè Allum√©";
                badge.className = badge.className.replace('text-slate-400', 'text-sky-400');
            } else if(card) {
                card.classList.remove('is-on');
                badge.innerText = "‚óã √âteint";
                badge.className = badge.className.replace('text-sky-400', 'text-slate-400');
            }
        }

        async function toggle(id, state) {
            updateVisual(id, state);
            await sendCmd(id, 'switch_led', state);
        }

async function sendCmd(deviceId, code, value) {
    const res = await api({ action: 'send', deviceId, code, value });
    if (!res.success) {
        showToast("Erreur de connexion √† l'ampoule", "error");
    }
    return res;
}

        async function resetWhite(id) {
            await sendCmd(id, 'work_mode', 'white');
            await sendCmd(id, 'bright_value_v2', 1000);
            await sendCmd(id, 'temp_value_v2', 500);
            syncStatus(id);
        }

async function masterOff() {
    const modal = document.getElementById('custom-confirm');
    modal.classList.remove('hidden');

    // On cr√©e une promesse pour attendre le clic
    const userChoice = await new Promise((resolve) => {
        document.getElementById('confirm-yes').onclick = () => resolve(true);
        document.getElementById('confirm-no').onclick = () => resolve(false);
    });

    modal.classList.add('hidden');

    if (userChoice) {
        showToast("Extinction globale...", "error");
        devicesCache.forEach(async d => {
            if(d.online) {
                await sendCmd(d.id, 'switch_led', false);
                const sw = document.getElementById(`sw-${d.id}`);
                if(sw) sw.checked = false;
                updateVisual(d.id, false);
            }
        });
    }
}

        function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerText = message;
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = '0.5s';
        setTimeout(() => toast.remove(), 500);
    }, 3000);
}

        function toggleColor(id) {
            const p = document.getElementById(`pk-${id}`);
            p.classList.toggle('hidden');
            if(!pickers[id]) {
                pickers[id] = new iro.ColorPicker(`#pk-${id}`, { width: 160, layout: [{ component: iro.ui.Wheel }] });
                pickers[id].on('input:end', (c) => {
                    sendCmd(id, 'work_mode', 'colour');
                    sendCmd(id, 'colour_data_v2', { h: c.hsv.h, s: c.hsv.s * 10, v: c.hsv.v * 10 });
                });
            }
        }
    </script>
</body>
</html>
